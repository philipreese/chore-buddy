<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ChoreBuddy.Views.ChoreDetailsPage"
             xmlns:views="clr-namespace:ChoreBuddy.Views"
             xmlns:vm="clr-namespace:ChoreBuddy.ViewModels"
             xmlns:models="clr-namespace:ChoreBuddy.Models"
             xmlns:c="clr-namespace:ChoreBuddy.Converters"
             x:DataType="vm:ChoreDetailViewModel"
             x:Name="ThisPage"
             Title="{Binding PageTitle}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <c:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *"
          Padding="20"
          BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}">
        <Grid Grid.Row="0"
              ColumnDefinitions="*, Auto"
              Padding="15"
              BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray800}}">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Tapped="OnToggleEditPanelClicked" />
            </Grid.GestureRecognizers>
            <CollectionView ItemsSource="{Binding SelectedTags}"
                            VerticalOptions="Center"
                            InputTransparent="True"
                            HorizontalScrollBarVisibility="Never"
                            HeightRequest="30">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal"                                       
                                       ItemSpacing="6" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Tag">
                        <Border Padding="10,3"
                                StrokeShape="RoundRectangle 10" 
                                BackgroundColor="{Binding ColorHex}">
                            <Label Text="{Binding Name}"
                                   FontSize="13"
                                   Shadow="0 1 0.5 Black 1"
                                   TextColor="White"
                                   FontAttributes="Bold" />
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
            <Image Grid.Column="1"
                   Margin="15,2"                   
                   HorizontalOptions="End"
                   WidthRequest="16"
                   BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray800}}">
                <Image.Source>
                    <FontImageSource FontFamily="FontAwesome"
                                     Glyph="&#xf040;"   
                                     Color="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource Gray100}}"/>
                </Image.Source>
            </Image>
        </Grid>
        <ScrollView Grid.Row="1">
            <Grid RowDefinitions="Auto, Auto, *">
                <VerticalStackLayout x:Name="EditPanel" 
                                     Grid.Row="0" 
                                     Spacing="20" 
                                     Padding="20" 
                                     IsVisible="False"
                                     ZIndex="1"
                                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}">
                    <StackLayout Spacing="10">
                        <Entry x:Name="ChoreNameEntry"
                               Placeholder="Chore Name"
                               Text="{Binding Chore.Name}"
                               FontSize="Large"
                               FontAttributes="Bold"/>
                    </StackLayout>

                    <Label Text="Tags"
                           FontAttributes="Bold"
                           FontSize="Medium" />
                    <Grid ColumnDefinitions="Auto, *"
                          VerticalOptions="Center">
                        <Button Background="{StaticResource Gray100}"
                                BorderColor="{StaticResource Gray500}"
                                BorderWidth="1.5"
                                HeightRequest="10"
                                CornerRadius="15"
                                Margin="0,0,8,8"
                                Command="{Binding AddTagCommand}">
                            <Button.ImageSource>
                                <FontImageSource FontFamily="FontAwesome"
                                                 Glyph="&#xf067;"
                                                 Size="14"                                                 
                                                 Color="{StaticResource Gray900}"/>
                            </Button.ImageSource>
                        </Button>
                        <FlexLayout Grid.Column="1"
                                    BindableLayout.ItemsSource="{Binding AvailableTags}"
                                    Wrap="Wrap">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="models:Tag">
                                    <Border Margin="0,0,4,8"
                                            Padding="12,5"
                                            StrokeShape="RoundRectangle 15">
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                                <Setter Property="BackgroundColor" Value="{Binding ColorHex}" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="False">
                                                <Setter Property="BackgroundColor" Value="Transparent" />
                                                <Setter Property="Stroke" Value="Gray" />
                                            </DataTrigger>
                                        </Border.Triggers>

                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding x:DataType='views:ChoreDetailsPage', Source={x:Reference ThisPage}, Path=ViewModel.ToggleTagCommand}"
                                                              CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>

                                        <Label Text="{Binding Name}"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               InputTransparent="True">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="True">
                                                    <Setter Property="TextColor" Value="White" />
                                                    <Setter Property="Shadow">
                                                        <Shadow Brush="Black" Offset="0,1" Opacity="0.5" Radius="1"/>
                                                    </Setter>
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </FlexLayout>
                    </Grid>

                    <Button Text="Save Chore"
                            Command="{Binding SaveChoreCommand}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White" />
                </VerticalStackLayout>

                <Label Grid.Row="1" 
                       Text="Completion History"
                       FontSize="Large"
                       FontAttributes="Bold"
                       Margin="0,10,0,10"/>

                <CollectionView Grid.Row="2"
                                ItemsSource="{Binding History}"
                                SelectionMode="None">

                    <CollectionView.EmptyView>
                        <Label Text="No completion history found yet. Mark it as done on the main screen!"
                               Margin="20"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               TextColor="{StaticResource Gray300}"/>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:CompletionRecord">
                            <SwipeView>
                                <SwipeView.LeftItems>
                                    <SwipeItems Mode="Reveal">
                                        <SwipeItemView BackgroundColor="Red"
                                                       Command="{Binding x:DataType='views:ChoreDetailsPage', Source={x:Reference ThisPage}, Path=ViewModel.DeleteCompletionRecordCommand}"
                                                       CommandParameter="{Binding .}">
                                            <Grid WidthRequest="60">
                                                <Image WidthRequest="24">
                                                    <Image.Source>
                                                        <FontImageSource FontFamily="FontAwesome" 
                                                                         Glyph="&#xf1f8;"                                                                 
                                                                         Color="{StaticResource White}"/>
                                                    </Image.Source>
                                                </Image>
                                            </Grid>
                                        </SwipeItemView>
                                    </SwipeItems>
                                </SwipeView.LeftItems>

                                <Border Padding="15"
                                        Margin="0, 5"
                                        Background="{AppThemeBinding Light=White, Dark={StaticResource Gray800}}"
                                        StrokeShape="RoundRectangle 10">
                                    <Grid RowDefinitions="*, Auto">
                                        <Grid.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding x:DataType='views:ChoreDetailsPage', Source={x:Reference ThisPage}, Path=ViewModel.EditCompletionNoteCommand}"
                                                                  CommandParameter="{Binding .}" />
                                        </Grid.GestureRecognizers>
                                        <Label Grid.Row="0" 
                                               Text="{Binding CompletedAt, StringFormat='{0:MMM dd, yyyy @ hh:mm tt}'}" 
                                               FontSize="Medium" 
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"/>
                                        <Label Grid.Row="1"
                                               Text="{Binding Note}"
                                               IsVisible="{Binding Note, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                               TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray300}}"
                                               FontSize="Medium" />
                                    </Grid>
                                </Border>
                            </SwipeView>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </ScrollView>
    </Grid>
</ContentPage>