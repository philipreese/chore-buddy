<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ChoreBuddy.Views.MainPage"
             xmlns:views="clr-namespace:ChoreBuddy.Views"
             xmlns:vm="clr-namespace:ChoreBuddy.ViewModels"
             xmlns:models="clr-namespace:ChoreBuddy.Models"
             xmlns:c="clr-namespace:ChoreBuddy.Converters"
             x:Name="ThisPage"
             Shell.NavBarIsVisible="False"
             Style="{StaticResource PageRoot}"
             x:DataType="vm:MainViewModel">

    <Grid RowDefinitions="Auto,Auto,*"
          Padding="4">

        <views:ToolbarView Grid.Row="0" x:DataType="vm:MainViewModel"/>
        
        <Border Grid.Row="1"
                Margin="0,0,0,8"
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceContainerLightDim}, Dark={StaticResource SurfaceContainerDarkBright}}"
                StrokeShape="RoundRectangle 48"
                Padding="16"
                Style="{StaticResource Card}">

            <CollectionView ItemsSource="{Binding FilterTags}"
                            HorizontalScrollBarVisibility="Never"
                            VerticalOptions="Center"
                            ItemTemplate="{StaticResource FilterChipTemplate}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" />
                </CollectionView.ItemsLayout>
                <CollectionView.EmptyView>
                    <Label HorizontalOptions="Center"
                           FontSize="16"
                           Style="{StaticResource BodyText}"
                           Text="Add some tags to organize your missions!" />
                </CollectionView.EmptyView>
            </CollectionView>
        </Border>

        <CollectionView Grid.Row="2"
                        x:Name="ChoreList"
                        ItemsSource="{Binding Chores}"
                        RemainingItemsThreshold="5"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Grid x:DataType="{x:Null}">
                    <ContentView ControlTemplate="{StaticResource HeroEmptyStateTemplate}"
                                 IsVisible="{Binding BindingContext.IsTotalEmpty, Source={x:Reference ThisPage}}">
                        <ContentView.BindingContext>
                            <models:EmptyStateInfo 
                                Title="The Signal is Silent" 
                                Description="The household is at peace. No missions currently require your attention. Tap the + to find a new challenge." />
                        </ContentView.BindingContext>
                    </ContentView>

                    <ContentView ControlTemplate="{StaticResource HeroEmptyStateTemplate}"
                                 IsVisible="{Binding BindingContext.IsFilterEmpty, Source={x:Reference ThisPage}}">
                        <ContentView.BindingContext>
                            <models:EmptyStateInfo 
                                Title="No Missions in Sector" 
                                Description="There are chores recorded, but none match your current filters. Adjust your gear to see more missions." />
                        </ContentView.BindingContext>
                    </ContentView>
                </Grid>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChoreDisplayItem">
                    <SwipeView>
                        <SwipeView.LeftItems>
                            <SwipeItems Mode="Reveal">
                                <SwipeItemView BackgroundColor="{AppThemeBinding Light={StaticResource ErrorLight}, Dark={StaticResource ErrorDark}}"
                                               Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.DeleteChoreCommand}"
                                               CommandParameter="{Binding .}">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf1f8;"
                                           FontSize="28"
                                           Padding="25,0"
                                           TextColor="{AppThemeBinding Light={StaticResource OnErrorLight}, Dark={StaticResource OnErrorDark}}" />
                                </SwipeItemView>
                            </SwipeItems>
                        </SwipeView.LeftItems>
                        <SwipeView.RightItems>
                            <SwipeItems Mode="Reveal">
                                <SwipeItemView BackgroundColor="{AppThemeBinding Light={StaticResource TertiaryContainerLight}, Dark={StaticResource TertiaryContainerDark}}"
                                               Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.ArchiveChoreCommand}"
                                               CommandParameter="{Binding .}">
                                    <Label FontFamily="FontAwesome"
                                           Text="&#xf187;"
                                           FontSize="28"
                                           Padding="25,0"
                                           TextColor="{AppThemeBinding Light={StaticResource OnTertiaryContainerLight}, Dark={StaticResource OnTertiaryContainerDark}}" />
                                </SwipeItemView>
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Border Style="{StaticResource Card}"
                                Margin="0,8">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.GoToDetailsCommand}"
                                                          CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>

                                <Label Text="&#xf0f3;"
                                       FontFamily="FontAwesome"
                                       FontSize="20"
                                       Margin="0,0,8,0"
                                       IsVisible="{Binding NextDueDate, Converter={StaticResource IsNotNullConverter}}"
                                       TextColor="{Binding NextDueDate, Converter={StaticResource DueToColorConverter}}"
                                       BackgroundColor="Transparent"
                                       Style="{StaticResource BodyText}" />

                                <VerticalStackLayout Grid.Column="1"
                                                     Padding="5"
                                                     VerticalOptions="Center">

                                    <Label Text="{Binding Name}"
                                           Style="{StaticResource HeaderText}"
                                           MaxLines="2"
                                           LineBreakMode="TailTruncation" />
                                    <FlexLayout BindableLayout.ItemsSource="{Binding Tags}"
                                                Wrap="Wrap"
                                                BindableLayout.ItemTemplate="{StaticResource TagTemplate}" />
                                    <VerticalStackLayout IsVisible="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.IsHistoryVisible}">
                                        <Label Text="{Binding LastNote}"
                                           Margin="0,10,0,0"
                                           Style="{StaticResource GrayBodyText}"
                                           MaxLines="3"
                                           LineBreakMode="TailTruncation" 
                                           IsVisible="{Binding LastNote, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                                        <Label Text="{Binding LastCompleted, StringFormat='Done: {0:MMM dd, yyyy @ hh:mm tt}'}"
                                           Style="{StaticResource BodyText}"
                                           Margin="0,10,0,0"
                                           IsVisible="{Binding LastCompleted, Converter={StaticResource IsNotNullOrEmptyConverter}}" />
                                    </VerticalStackLayout>

                                    <HorizontalStackLayout Spacing="4" 
                                                           IsVisible="{Binding NextDueDate, Converter={StaticResource IsNotNullConverter}}">
                                        <Label Text="Due:"
                                               Style="{StaticResource BodyText}" />
                                        <Label Text="{Binding NextDueDate, StringFormat='{0:MMM dd, yyyy @ hh:mm tt}'}" 
                                               TextColor="{Binding NextDueDate, Converter={StaticResource DueToColorConverter}}"
                                               Style="{StaticResource BodyText}" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>

                                <Button Grid.Column="2"
                                        Text="&#xf046;"
                                        Margin="10,5"
                                        FontFamily="FontAwesome"
                                        Style="{StaticResource IconButton}"
                                        Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.CompleteChoreCommand}"
                                        CommandParameter="{Binding .}" />
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.Footer>
                <BoxView HeightRequest="80" />
            </CollectionView.Footer>
        </CollectionView>

        <Button Grid.Row="2"
                Style="{StaticResource FloatingActionButton}"
                Text="&#xf067;"
                FontFamily="FontAwesome"
                Command="{Binding AddChoreCommand}" />
        
    </Grid>
</ContentPage>
