<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="ChoreBuddy.Views.MainPage"
             xmlns:views="clr-namespace:ChoreBuddy.Views"
             xmlns:vm="clr-namespace:ChoreBuddy.ViewModels"
             xmlns:models="clr-namespace:ChoreBuddy.Models"
             xmlns:b="clr-namespace:ChoreBuddy.Behaviors"
             xmlns:c="clr-namespace:ChoreBuddy.Converters"
             x:Name="ThisPage"
             x:DataType="vm:MainViewModel"
             Title="Chore Buddy">

    <ContentPage.BindingContext>
        <vm:MainViewModel x:DataType="vm:MainViewModel"/>
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <c:IsNotNullOrEmptyConverter x:Key="IsNotNullOrEmptyConverter" />
            <c:IsGreaterThanZeroConverter x:Key="IsGreaterThanZeroConverter" />
        </ResourceDictionary>

        <Style x:Key="SortDateButtonStyle"
               TargetType="ToolbarItem">
            <Style.Triggers>
                <DataTrigger TargetType="ToolbarItem" 
                             Binding="{Binding CurrentSortOrder}" 
                             Value="{x:Static vm:ChoreSortOrder.LastCompleted}">
                    <Setter Property="IconImageSource">
                        <Setter.Value>
                            <FontImageSource FontFamily="FontAwesome" 
                                             Glyph="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.DateSortIconGlyph}"
                                             Color="{StaticResource Secondary}"/>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="SortNameButtonStyle" TargetType="ToolbarItem">
            <Style.Triggers>
                <DataTrigger TargetType="ToolbarItem" 
                             Binding="{Binding CurrentSortOrder}" 
                             Value="{x:Static vm:ChoreSortOrder.Name}">
                    <Setter Property="IconImageSource">
                        <Setter.Value>
                            <FontImageSource FontFamily="FontAwesome" 
                                             Glyph="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.NameSortIconGlyph}"
                                             Color="{StaticResource Secondary}"/>
                        </Setter.Value>
                    </Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>

        <ToolbarItem Command="{Binding SortChoresCommand}"
                     CommandParameter="{x:Static vm:ChoreSortOrder.LastCompleted}"
                     Style="{StaticResource SortDateButtonStyle}"
                     Order="Primary">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                                 Glyph="{Binding DateSortIconGlyph}"
                                 Color="{StaticResource Gray500}"/>
            </ToolbarItem.IconImageSource>
        </ToolbarItem>

        <ToolbarItem Command="{Binding SortChoresCommand}"
                     CommandParameter="{x:Static vm:ChoreSortOrder.Name}"
                     Style="{StaticResource SortNameButtonStyle}"
                     Order="Primary">
            <ToolbarItem.IconImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                                 Glyph="{Binding NameSortIconGlyph}"
                                 Color="{StaticResource Gray500}"/>
            </ToolbarItem.IconImageSource>
        </ToolbarItem>

        <ToolbarItem Text="Edit Tags"
                     Command="{Binding NavigateToTagsCommand}"
                     Order="Secondary" />
        <ToolbarItem Text="Delete All"
                     Command="{Binding DeleteAllChoresCommand}"
                     Order="Secondary" />
        <ToolbarItem Text="About"
                     Command="{Binding NavigateToAboutCommand}"
                     Order="Secondary" />
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto, Auto, *" 
          Padding="20"
          Background="Transparent">
        <Border Grid.Row="0"
                BackgroundColor="{AppThemeBinding Light=White, Dark={StaticResource Gray800}}"
                IsVisible="{Binding FilterTags.Count, Converter={StaticResource IsGreaterThanZeroConverter}}"
                Padding="10"
                StrokeShape="RoundRectangle 10">
            <CollectionView ItemsSource="{Binding FilterTags}"
                            HorizontalScrollBarVisibility="Never"
                            HeightRequest="36">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal"                                       
                                       ItemSpacing="6" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>                    
                    <DataTemplate x:DataType="models:Tag">
                        <Border Padding="12,3"
                                StrokeShape="RoundRectangle 10" 
                                BackgroundColor="{Binding ColorHex}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.ToggleFilterTagCommand}"
                                                      CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                    <Setter Property="BackgroundColor" Value="{Binding ColorHex}" />
                                    <Setter Property="Stroke" Value="Transparent" />
                                </DataTrigger>
                                <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="False">
                                    <Setter Property="BackgroundColor" Value="Transparent" />
                                    <Setter Property="Stroke" Value="{StaticResource Gray200}" />
                                </DataTrigger>
                            </Border.Triggers>

                            <Label Text="{Binding Name}"
                                   FontSize="20"
                                   HorizontalOptions="Center">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="True">
                                        <Setter Property="TextColor" Value="White" />
                                        <Setter Property="Shadow">
                                            <Shadow Brush="Black" Offset="0,1" Opacity="0.5" Radius="1"/>
                                        </Setter>
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsSelected}" Value="False">
                                        <Setter Property="TextColor" Value="{StaticResource Gray200}" />
                                        <Setter Property="Shadow">
                                            <Shadow Brush="Black" Offset="0,0" Opacity="0" Radius="0"/>
                                        </Setter>
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Border>

        <BoxView Grid.Row="1" 
                 Margin="0,10"
                 HeightRequest="3"
                 IsVisible="{Binding FilterTags.Count, Converter={StaticResource IsGreaterThanZeroConverter}}"
                 Color="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray500}}" />
        <CollectionView Grid.Row="2"
                        x:Name="ChoreList"
                        ItemsSource="{Binding Chores}"  
                        RemainingItemsThreshold="5"
                        SelectionMode="None">

            <CollectionView.EmptyView>
                <Label Text="{Binding EmptyListMessage}"
                       Margin="20"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="{StaticResource Gray300}"/>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChoreDisplayItem">
                    <SwipeView>
                        <SwipeView.LeftItems>
                            <SwipeItems Mode="Reveal">
                                <SwipeItemView BackgroundColor="Red"
                                               Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.DeleteChoreCommand}"
                                               CommandParameter="{Binding .}">
                                    <Grid WidthRequest="60">
                                        <Image WidthRequest="24">
                                            <Image.Source>
                                                <FontImageSource FontFamily="FontAwesome" 
                                                                 Glyph="&#xf1f8;"                                                                 
                                                                 Color="{StaticResource White}"/>
                                            </Image.Source>
                                        </Image>
                                    </Grid>
                                </SwipeItemView>
                            </SwipeItems>
                        </SwipeView.LeftItems>

                        <Border Padding="15"
                                Margin="0, 5"
                                Background="{AppThemeBinding Light=White, Dark={StaticResource Gray800}}"
                                StrokeShape="RoundRectangle 10">

                            <Grid ColumnDefinitions="*, Auto">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.GoToDetailsCommand}"
                                                          CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                                
                                <VerticalStackLayout Grid.Column="0"
                                                     VerticalOptions="Center">
                                    <Label Text="{Binding Name}"
                                           FontSize="Large"
                                           FontAttributes="Bold"/>

                                    <FlexLayout BindableLayout.ItemsSource="{Binding Tags}"
                                                Wrap="Wrap"
                                                Margin="0,2">
                                        <BindableLayout.ItemTemplate>
                                            <DataTemplate x:DataType="models:Tag">
                                                <Border Margin="0,0,1,0"
                                                        Padding="10,3"
                                                        StrokeShape="RoundRectangle 10" 
                                                        BackgroundColor="{Binding ColorHex}">
                                                    <Label Text="{Binding Name}"
                                                           FontSize="13"
                                                           Shadow="0 1 0.5 Black 1"
                                                           TextColor="White"
                                                           FontAttributes="Bold" />
                                                </Border>
                                            </DataTemplate>
                                        </BindableLayout.ItemTemplate>
                                    </FlexLayout>

                                    <Label Text="{Binding LastNote}"
                                           FontSize="Medium" 
                                           IsVisible="{Binding LastNote, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray100}}"
                                           InputTransparent="True" />
                                    <Label FontSize="Small" 
                                           IsVisible="{Binding LastCompleted, Converter={StaticResource IsNotNullOrEmptyConverter}}"
                                           TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray300}}">
                                        <Label.Text>
                                            <MultiBinding StringFormat="{}{0}">
                                                <Binding Path="LastCompleted" 
                                                         StringFormat="{}{0:MMM dd, yyyy @ hh:mm tt}"
                                                         FallbackValue="Never"/>
                                            </MultiBinding>
                                        </Label.Text>
                                    </Label>
                                </VerticalStackLayout>

                                <Button Grid.Column="1" 
                                        Text="Complete"
                                        FontSize="Medium"
                                        HeightRequest="48"
                                        CornerRadius="18"
                                        BackgroundColor="{StaticResource Primary}"
                                        TextColor="{StaticResource White}"
                                        Command="{Binding x:DataType='views:MainPage', Source={x:Reference ThisPage}, Path=ViewModel.CompleteChoreCommand}"
                                        CommandParameter="{Binding .}"
                                        Margin="10, 0, 0, 0"/>
                            </Grid>
                        </Border>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
            
            <CollectionView.Footer>
                <BoxView HeightRequest="70" BackgroundColor="Transparent" />
            </CollectionView.Footer>
        </CollectionView>

        <Button Grid.Row="2"
                HorizontalOptions="End"
                VerticalOptions="End"
                CornerRadius="35"
                Shadow="-2 2 4 #212121"
                Background="{StaticResource Primary}"
                Command="{Binding AddChoreCommand}">
            <Button.ImageSource>
                <FontImageSource FontFamily="FontAwesome" 
                                 Glyph="&#xf067;"
                                 Size="40"
                                 Color="White"/>
            </Button.ImageSource>
        </Button>
    </Grid>
</ContentPage>